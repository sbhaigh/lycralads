<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lycra Lads</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.4.3/css/mdb.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.4.3/js/mdb.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.5.1/tabletop.min.js"></script>
        <!-- Load c3.css -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.18/c3.min.css" rel="stylesheet">

    <!-- Load d3.js and c3.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.18/c3.min.js"></script>
    <script type='text/javascript'>
        var publicSpreadsheetUrl = 'https://docs.google.com/spreadsheets/d/1vhMCeXUj6xCDBul0sZq4GC3RhZMheP_huSzXgYuEfeY/pubhtml';

        function init() {
            Tabletop.init( { key: publicSpreadsheetUrl,
                callback: showInfo,
                simpleSheet: true } )
        }

        function showInfo(data, tabletop) {
            // get a list of tabs and find the latest one (biggest number)
            var thisYear = tabletop.foundSheetNames[0];
            var thisYearsSheet = tabletop.sheets(thisYear);
            console.log(thisYear);
            console.log(thisYearsSheet);

            var count = 0;
            var div = document.getElementById('data'),
                html = "<h1>" + thisYear + "</h1>",
                prop, i;

            html = html + "<table class='table table-bordered'><thead><tr>"

            var summaryStats = new Array();
            var excludes = new Array('x', 'Av. speed', 'Sprint - 1st', 'Sprint - 2nd', 'Sprint - 3rd', 'Route');
            function isInArray(value, array) {
                return array.indexOf(value) > -1;
            }
            // for each column add the riders name, distance and sprint points to a dictionary
            for(i = 0; i < thisYearsSheet.originalColumns.length; i++) {
                if(!isInArray(thisYearsSheet.columnNames[i], excludes)) {
                    var dict = [];
                    dict['name'] = thisYearsSheet.columnNames[i];
                    dict['miles'] = thisYearsSheet.elements[0][thisYearsSheet.columnNames[i]];
                    dict['sprintPoints'] = thisYearsSheet.elements[1][thisYearsSheet.columnNames[i]]
                    
                    var rides = 0;
                    for(j = 2; j < thisYearsSheet.elements.length; j++) {
                        if(parseFloat(thisYearsSheet.elements[j][thisYearsSheet.columnNames[i]])) {
                            rides = rides + 1;
                        }
                    }
                    dict['numberOfRides'] = rides;
                    dict['averageSprintPointsPerRide'] = parseInt(thisYearsSheet.elements[1][thisYearsSheet.columnNames[i]]) / rides;
                    summaryStats.push(dict);
                }
                html = html + "<th>" + thisYearsSheet.columnNames[i] + "</th>";
            }
            console.log(summaryStats);
            html = html + "</tr></thead><tbody class='table-striped'>";

            for(i = 0; i < thisYearsSheet.elements.length; i++) {
                html = html + "<tr>";
                for(prop in thisYearsSheet.elements[i]) {
                    html = html + "<td>" + thisYearsSheet.elements[i][prop] + "</td>";
                }
                html = html + "</tr>";
            }
            html = html + "</tbody></table>"
            
            div.innerHTML = div.innerHTML + html;

            var chart = c3.generate({
                bindto: '#chart',
                data: {
  
                    json: { summaryStats }
                ,
                types: { 
                    data1: 'bar'}
                },
                axis: {
                    rotated: true
                }
            });
        }

        window.addEventListener('DOMContentLoaded', init)
    </script>
</head>
<body>

    <div id="chart"></div>
    <div id="data"></div>



</body>
</html>